# GSTT SDE Network Infrastructure Deployment Pipeline
# Terraform-based infrastructure as code deployment

trigger:
  branches:
    include:
    - main
    - feature/*
#  paths:
#    include:
#    - /landing-zone/*
#    exclude:
#    - /documentation/*

parameters:
  - name: ENVIRONMENT
    displayName: Choose an environment
    type: string
    default: DEV
    values:
      - DEV
      - HML
      - PRD
  - name: tfConfiguration
    displayName: TF runtime configuration
    type: string
    default: gstt-lz
    values:
    - gstt-lz
  - name: tfOperation
    displayName: TF operation name
    type: string
    default: plan
    values:
    - plan
    - plan-jsonop
    - test
    - apply
    - destroy
  - name: projectName
    displayName: Project to deploy
    type: string
    default: network
    values:
    - network
    - core
    - network-routing
    - policy
    - data-factory
    - compute

pool:
  name: gsttsdeipipelines

variables:
  - group: PipelineVars-DEV
  - name: serviceConnection
    value: 'gstt-az-sub-hub-01'
  
steps:
- task: TerraformInstaller@1
  displayName: 'Install Terraform CLI'
  inputs:
    terraformVersion: latest

# Run Terraform deployment
- task: AzureCLI@2
  displayName: "Run Terraform - ${{ parameters.projectName }}"
  inputs:
    azureSubscription: $(serviceConnection)
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      echo "âœ… Authenticated to Azure with Federated Identity"
      az account show
      
      echo "============================================"
      echo "GSTT SDE Terraform Deployment"
      echo "Environment: ${{ parameters.ENVIRONMENT }}"
      echo "Project: ${{ parameters.projectName }}"
      echo "Operation: ${{ parameters.tfOperation }}"
      echo "============================================"
      
      chmod +x landing-zone/build-tools/build-hub.sh
      landing-zone/build-tools/build-hub.sh ${{ parameters.tfOperation }}
  env:
    ENVIRONMENT: ${{ parameters.ENVIRONMENT }}
    DEPLOYMENT_AREA: ${{ parameters.tfConfiguration }}
    PROJECT_NAME: ${{ parameters.projectName }}
    TF_VAR_tfstate_storage_access_key: $(state-storage-access-key-dev)
    TF_VAR_state_storage_acct_name: $(state-storage-acct-name-dev) 
    TF_VAR_state_storage_rg: $(state-storage-rg-dev)
    TF_VAR_state_storage_container_name: $(state-storage-container-name-dev)
    TF_VAR_environment: ${{ parameters.ENVIRONMENT }}
    TF_VAR_azure_tenant_id: $(ARM_TENANT_ID)
    TF_VAR_azure_client_id: $(clientId)
    TF_VAR_admin_password: $(admin_password)
    AUTO_APPROVE_OPERATION: "-auto-approve"
    ARM_USE_OIDC: "true"
    ARM_CLIENT_ID: $(ARM_CLIENT_ID)
    ARM_TENANT_ID: $(ARM_TENANT_ID)
    ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
